<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Notes</title>
</head>
<body>
  <div class="content">
    <h1 id="-7-node-js-">笔记：7天搞定Node.js微信公众号开发</h1>
<p>更新日期：2016-10-10</p>
<h2 id="ch01-">CH01 前期准备</h2>
<h3 id="1-1-http-coding-imooc-com-lesson-38-html-mid-249-">1-1 <a href="http://coding.imooc.com/lesson/38.html#mid=249">课程简介</a></h3>
<p>js sdk: 公众号开发需要与公众号后台有交互，需要在后台网页进行配置，比如通信的域名地址，js sdk 的授权地址等等</p>
<p>yield: 这个Node.js 项目会用到不少框架模块，并没有 100% 用 ES6 的规范来开发，而是混用了一些 ES6 的特性，比如 yield</p>
<p>koa：项目的 web 层使用的框架是 Koa，主要用来处理服务器之间的应用初始化、接口调用以及数据的相应</p>
<p>bluebird: Promise 尽管在高版本的 Node.js 里面已经原生提供，我们还是用到了一个 Promise 库，就是 bluebird，用来处理和分装异步请求</p>
<p>Request: 网路请求我们使用 request，他是对原生 http request 的分装</p>
<p>ejs：微信的数据包装方式是 XML，所以我们借助 ejs 这个模板库，把数据作为变量替换到 XML 字符中</p>
<p>lodash: 一些常用的方法集，做数组拆分，类型判断等等</p>
<p>Heredoc：是一个黑科技，把很熟体里面的多行的注释作为字符串提取出来，主要用来降低拼接字符串的成本</p>
<p>raw-body: 用来获取一个 http 请求返回的刻度流的内容实体</p>
<p>sha1： 哈希加密算法库</p>
<p>xml2js: 微信服务器返回的数据是 xml 格式，我们借助 xml2js 这个模块把 xml 数据解析为 js 对象，方便我们使用</p>
<p>Prerequisite：</p>
<ul>
<li>第一：能利用 Nodejs 开发一些网页或者爬虫工具，来对 Node.js API 和它的技术特点有一些基本的认知</li>
<li>第二：有一些其他的后端语言开发经验，PHP/JAVA/Ruby 均可，主要弄明白一个网络 http 请求从开始到结束中间所经过的这些环节</li>
<li>第三：会使用 Javascript</li>
</ul>
<h3 id="1-2-http-coding-imooc-com-lesson-38-html-mid-250-">1-2 <a href="http://coding.imooc.com/lesson/38.html#mid=250">简介</a></h3>
<ul>
<li>了解微信号的种类特点</li>
<li>本地代理环境的搭建以及最入门的加密认证</li>
</ul>
<h3 id="1-3-http-coding-imooc-com-lesson-38-html-mid-251-">1-3 <a href="http://coding.imooc.com/lesson/38.html#mid=251">微信号分类和功能</a></h3>
<p>微信号分类</p>
<ul>
<li>企业号：是为企业或组织提供移动应用入口，帮助企业建立与员工、上下游供应链及企业应用间的链接。</li>
<li>订阅号：适合与个人，小团队，主要是用于信息传播，帮助管理洪湖以及和胡勇互动。比如撰写文章，咨询传播，消息定制等等</li>
<li>服务号：企业和组织，提供更强大的业务服务与用户管理能力。比如支付，智能接口</li>
</ul>
<p>服务号的 9 大接口</p>
<ul>
<li>语音识别：能识别你说的话，并翻译成文本内容</li>
<li>客服接口：公众号可以在你发送过消息的 24 小时内，想你回复消息</li>
<li>OAuth 2.0 网页授权：可以通过这个授权接口，请求用户授权，从而拿到更多用户的信息</li>
<li>生成带参数的二维码：公众号可以获得一系列携带不同参数的二维码，在用户扫描关注公众号后公众号可以根据参数分析各二维码的效果，这些参数可以自己定制，从而可以实现更多分析结果，比如用户从哪儿来的</li>
<li>获取用户地理位置：公众号能够获得用户进入公众号会话时的地理位置，可以做微信导航</li>
<li>获取用户基本信息：公众号可以根据加密后的用户 OpenID ，通过一系列的参数交互，最终拿到用户基本信息，包括头像、名称、性别、地区</li>
<li>获取关注者列表：通过这个接口，可以拿到所有关注着的 OpenID，就知道有多少人关注你，是谁在关注你</li>
<li>用户分组接口：通过分组接口，可以在后台为用户移动、创建、修改分组</li>
<li>上传下载多媒体文件：通过这个接口，公众号可以在需要时在微信服务器上传下载多媒体文件</li>
</ul>
<p>订阅号的 5 个接口</p>
<ul>
<li>会话界面的自定义菜单</li>
<li>多客服接口：提供贴心快捷的客服服务</li>
<li>获取用户地理位置：精确提供服务</li>
<li>高级群发接口：实现更灵活的群发能力</li>
<li>用户分组接口：方便管理用户</li>
</ul>
<h3 id="1-4-ngrok-http-coding-imooc-com-lesson-38-html-mid-252-">1-4 <a href="http://coding.imooc.com/lesson/38.html#mid=252">域名、服务器及 ngrok 环境配置</a></h3>
<p>通过ngrok，映射本地开发环境到外网，打通微信与本地开发环境的通道。</p>
<h3 id="1-5-http-coding-imooc-com-lesson-38-html-mid-253-">1-5 <a href="http://coding.imooc.com/lesson/38.html#mid=253">配置、接入微信公众号</a></h3>
<p>公众号接入分2步：</p>
<p>第一步：配置微信公众号后台</p>
<p>第二步：验证公众号</p>
<ul>
<li>将 token、timestamp、nonce 三个参数进行字典序排序</li>
<li>将三个参数字符串拼接成一个字符串进行 sha1 加密</li>
<li>将加密后的字符串与 signature 对比，如果相同，表示请求来源于微信，我们直接原样返回 echostr 参数内容，接入验证就成功了</li>
</ul>
<h3 id="1-6-http-coding-imooc-com-lesson-38-html-mid-254-">1-6 <a href="http://coding.imooc.com/lesson/38.html#mid=254">写段代码实现加密认证逻辑</a></h3>
<p>使用 koa 框架代码更精简，更易懂，对于反反复复的异步交互更适合用这个框架来实现。</p>
<h3 id="1-7-koa-">1-7 课程作业：利用 Koa 实现一个回声服务器</h3>
<p>项目作业：<a href="https://github.com/isjia/wizdigital-wechat-service">wizdigital-wechat-service</a></p>
<h2 id="ch02-">CH02 实战入门</h2>
<h3 id="2-1-">2-1 第二天简介</h3>
<ul>
<li>了解微信中消息回复的种类</li>
<li>完成一个简单的回复机器人小例子</li>
<li>使用 QQ 浏览器代理调试接口</li>
</ul>
<h3 id="2-2-qq-">2-2 利用 QQ 浏览器代理调试端口</h3>
<p>替代方案</p>
<ul>
<li><a href="http://www.utralhook.com">utralhook 服务</a></li>
<li>QQ 浏览器</li>
</ul>
<h3 id="2-3-7-6-">2-3 简述 7 种消息，6 种回复</h3>
<p>接收普通消息类型</p>
<ul>
<li>文本消息</li>
<li>图片消息</li>
<li>语音消息</li>
<li>视频消息</li>
<li>小视频消息</li>
<li>地理位置消息</li>
<li>链接消息</li>
</ul>
<p>被动回复用户消息类型</p>
<ul>
<li>回复文本消息</li>
<li>回复图片消息</li>
<li>回复语音消息</li>
<li>回复视频消息</li>
<li>回复音乐消息</li>
<li>回复图文消息</li>
</ul>
<h3 id="2-4-">2-4 注意事项总结</h3>
<ul>
<li>微信公众号接口只支持 80 端口</li>
<li>微信后台配置的 URL 是唯一能接收到消息、时间的入口，公众号的所有操作，都是基于这个 url 进行交互的</li>
<li>调用所有微信接口时几乎全部使用 https</li>
<li>用户想公众号发送消息是，会传过来 OpenID，OpenID 是用户微信号加密后的值，每个用户在每个公众号中 OpenID 是唯一的</li>
<li>在开发阶段要留意报错信息你比如全局返回码</li>
<li>在和微信服务器交互的时候，需要满足各个接口的规范限制、调用频率限制，要特别注意模板消息、用户数据等敏感信息的使用规范</li>
</ul>
<h3 id="2-5-">2-5 从封装和抽象开始</h3>
<ul>
<li>重新封装第一天的接入认证函数，使用中间件的形式改写</li>
</ul>
<blockquote>
<p>漂亮的代码不是一次写成的，是慢慢改出来的</p>
</blockquote>
<h3 id="2-6-access_token-">2-6 票据 access_token 打开新世界大门</h3>
<ul>
<li>access_token 每 2 个小时（7200 秒）自动失效，需要重新获取</li>
<li>只要更新了 access_token 之前的那个就不能用了</li>
<li>让系统每隔 2 个小时自动去刷新一次 access_token，这样无论何时我们内部调用接口这个票据始终是最新的</li>
<li>为了方便频繁调用，把 access_token 存储在一个地方，并且是唯一的一个地方</li>
</ul>

  </div>
</body>
</html>